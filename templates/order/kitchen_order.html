<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kitchen Orders</title>
    <!-- Full version of jQuery -->
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
</head>
<body>
    {% if role == 'SuperDistributor' %}
        {% include 'super_distributor/sd_header.html' %}
    {% elif role == 'Manager' %}
        {% include 'manager/manager_header.html' %}
    {% elif role == 'Distributor' %}
        {% include 'distributor/d_header.html' %}
    {% else %}
        {% include 'kitchen/kitchen_header.html' %}
    {% endif %}
    <div id="layoutSidenav_content">
        <main>
            <div class="container px-4">
                <div class="container my-4">
                    <h2 class="text-center text-primary animate__animated animate__fadeInDown">TOTAL ORDERS</h2>
                    <p class="text-muted text-center"></p>
                    {% with messages = get_flashed_messages() %}
                    {% if messages %}
                        <div class="messages">
                            {% for message in messages %}
                                <p>{{ message }}</p>
                            {% endfor %}
                        </div>
                    {% endif %}
                    {% endwith %}
                    <!-- Filters -->
                    <div class="row mb-4">
                        <form class="row g-3" method="GET" action="{{ url_for('order.kitchen_orders') }}">
                            <!-- Filter by Kitchen -->
                            {% if role == 'Kitchen' %}
                            <p></p>
                            {% else %}
                            <div class="col-md-3">
                                <label for="kitchen_filter">Filter by Kitchen:</label>
                                <select name="kitchen_id" id="kitchen_filter" class="form-select" onchange="this.form.submit()">
                                    <option value="All" {% if selected_kitchen_id == 'All' or not selected_kitchen_id %}selected{% endif %}>All</option>
                                    {% for kitchen in kitchens %}
                                        <option value="{{ kitchen.id }}" {% if selected_kitchen_id == kitchen.id|string %}selected{% endif %}>
                                            {{ kitchen.name }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}

                            <!-- Filter by Status -->
                            <div class="col-md-3">
                                <label for="status_filter">Filter by Status:</label>
                                <select name="status" id="status_filter" class="form-select" onchange="this.form.submit()">
                                    <option value="All" {% if order_status == 'All' %}selected{% endif %}>All</option>
                                    <option value="Processing" {% if order_status == 'Processing' %}selected{% endif %}>Processing</option>
                                    <option value="Completed" {% if order_status == 'Completed' %}selected{% endif %}>Completed</option>
                                    <option value="Cancelled" {% if order_status == 'Cancelled' %}selected{% endif %}>Cancelled</option>
                                    <option value="Pending" {% if order_status == 'Pending' %}selected{% endif %}>Pending</option>
                                </select>
                            </div>

                            <!-- Filter by Date -->
                            <div class="col-md-3">
                                <label for="date_filter">Filter by Date:</label>
                                <select name="date" id="date_filter" class="form-select" onchange="this.form.submit()">
                                    <option value="All" {% if date_filter == 'All' %}selected{% endif %}>All</option>
                                    <option value="Today" {% if date_filter == 'Today' %}selected{% endif %}>Today</option>
                                    <option value="Yesterday" {% if date_filter == 'Yesterday' %}selected{% endif %}>Yesterday</option>
                                    <option value="Weekly" {% if date_filter == 'Weekly' %}selected{% endif %}>Weekly</option>
                                    <option value="Monthly" {% if date_filter == 'Monthly' %}selected{% endif %}>Monthly</option>
                                    <option value="Yearly" {% if date_filter == 'Yearly' %}selected{% endif %}>Yearly</option>
                                </select>
                            </div>
                        </form>
                    </div>
                    <!-- Orders Table -->
                    <div class="row">
                        {% if orders_data %}
                        <div class="table-responsive">
                            <table class="table table-striped table-bordered table-hover" id="OrderTable">
                                <thead class="thead-dark text-center">
                                    <tr>
                                        <th>Sr No</th>
                                        <th>Order ID</th>
                                        <th>Customer</th>
                                        <th>Items Name</th>
                                        <th>Quantity</th>
                                        <th>Total Amount</th>
                                        {% if role == 'Kitchen' %}
                                        {% else %}
                                        <th>Kitchen Name</th>
                                        {% endif %}
                                        <th>Created At</th>
                                        <th>Status</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for order in orders_data %}
                                    <tr class="animated fadeInUp text-center">
                                        <td>{{ loop.index }}</td>
                                        <td>{{ order.order_id }}</td>
                                        <td>{{ order.customer_name }}</td>
                                        <td>
                                            {% for item in order['items'] %}
                                                {{ item.item_name }} <br>
                                            {% endfor %}
                                        </td>
                                        <td>
                                            {% for item in order['items'] %}
                                                {{ item.quantity }} <br>
                                            {% endfor %}
                                        </td>
                                        <td>₹{{ order.total_amount }}</td>
                                        {% if role == 'Kitchen' %}
                                        {% else %}
                                        <td>{{ order.kitchen_name }}</td>
                                        {% endif %}
                                        <td>{{ order.created_at }}</td>
                                        <td id="order-status-{{ order.order_id }}">{{ order.status }}</td>
                                        {% if order.status == "Completed" or order.status == 'Cancelled' %}
                                            <td id="order-action-{{ order.order_id }}">✓</td> <!-- Add ID for action column -->
                                        {% else %}
                                            {% if role=='Kitchen' %}
                                            <td id="order-action-{{ order.order_id }}">
                                                <a href="#" class="btn btn-info btn-sm update-order-btn" data-order-id="{{ order.order_id }}">Update</a>
                                            </td>
                                            {% endif %}
                                        {% endif %}
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <!-- Pagination Controls -->
                            <div class="d-flex float-right" id="pagination-controls"></div>
                        </div>
                        {% else %}
                        <div class="alert alert-info text-center">
                            You have no orders yet.
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </main>
        {% include 'admin/admin_footer.html' %}
    </div>

    <!-- Check if jQuery is loaded -->
    <script>
    $(document).ready(function() {
        console.log("jQuery is loaded and ready.");
    });
    </script>

    <script>
    var $j = jQuery.noConflict();
    $j(document).on("click", ".update-order-btn", function(event) {
        event.preventDefault();
        var order_id = $j(this).data("order-id");
        console.log("Order ID to update:", order_id); // Debug log
        $j.ajax({
            url: `/update-status/${order_id}`,
            type: "POST",
            success: function(response) {
                console.log("AJAX success response:", response); // Debug log
                // Update the status in the UI
                $j("#order-status-" + order_id).text(response.new_status);
                $j("#order-action-" + order_id).html('✓');
                alert(response.message);
            },
            error: function(xhr, status, error) {
                console.error("AJAX error:", xhr.responseJSON); // Debug log
                alert("Error: " + xhr.responseJSON.error);
            }
        });
    });
    </script>
</body>
</html>
